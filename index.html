<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KinApp - Motivational Workout</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="/static/manifest.json">

  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="KinApp">
  <link rel="apple-touch-icon" href="/static/icon-192.png">

  <!-- Theme Color -->
  <meta name="theme-color" content="#affc41">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@300;400;500;700;900&display=swap');

    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      vertical-align: middle;
      margin-right: 8px;
    }

    :root {
      /* Palette: Motivational Dark Mode */
      --primary: #affc41;
      /* Nike Volt / Neon Lime */
      --primary-hover: #96d936;
      --primary-light: rgba(175, 252, 65, 0.2);

      --bg: #0f172a;
      /* Slate 900 - Deep dark background */
      --card-bg: #1e293b;
      /* Slate 800 - Lighter card background */
      --sidebar-bg: #111827;
      /* Gray 900 */

      --text: #f8fafc;
      /* Slate 50 */
      --text-muted: #94a3b8;
      /* Slate 400 */
      --text-on-primary: #0f172a;
      /* Black text on neon button */

      --border: #334155;
      /* Slate 700 */

      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.2);
      --success: #10b981;

      /* Shadows & Effects */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
      --glow: 0 0 15px rgba(175, 252, 65, 0.4);

      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }

    body {
      font-family: 'Inter', 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 16px;
      background-color: var(--bg);
      background-image: radial-gradient(circle at top right, #1e293b 0%, transparent 40%), radial-gradient(circle at bottom left, #1e293b 0%, transparent 40%);
      color: var(--text);
      margin: 0;
      display: flex;
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background-color: var(--sidebar-bg);
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      z-index: 10;
    }

    .sidebar h1 {
      font-size: 24px;
      font-weight: 900;
      text-transform: uppercase;
      font-style: italic;
      text-align: left;
      margin-bottom: 48px;
      color: var(--primary);
      text-shadow: 0 0 10px rgba(175, 252, 65, 0.3);
      letter-spacing: -0.5px;
    }

    .menu-item {
      padding: 14px 18px;
      margin-bottom: 8px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid transparent;
    }

    .menu-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
      color: var(--text);
    }

    .menu-item.active {
      background-color: rgba(175, 252, 65, 0.1);
      color: var(--primary);
      border-color: var(--primary-light);
      box-shadow: 0 0 10px rgba(175, 252, 65, 0.1);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 40px;
      max-width: 900px;
      margin: 0 auto;
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1,
    h2,
    h3 {
      font-weight: 900;
      font-style: italic;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }

    h1 {
      font-size: 2.5em;
    }

    h2 {
      font-size: 2em;
    }

    h3 {
      font-size: 1.5em;
    }

    h2 {
      margin-bottom: 24px;
      letter-spacing: 0.5px;
      border-left: 5px solid var(--primary);
      padding-left: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-lg);
      margin-bottom: 24px;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid var(--border);
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
      border-color: var(--primary);
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-muted);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      background-color: #0f172a;
      /* Darker input bg */
      border-radius: var(--radius-md);
      margin-bottom: 24px;
      box-sizing: border-box;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s;
      color: var(--text);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      background-color: #1e293b;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-light);
    }

    button {
      width: 100%;
      padding: 16px;
      background: var(--primary);
      color: var(--text-on-primary);
      border: none;
      border-radius: var(--radius-md);
      font-size: 16px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: var(--glow);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(175, 252, 65, 0.6);
      filter: brightness(1.1);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    button.secondary:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      border-color: var(--text-muted);
    }

    button.danger {
      background: transparent;
      color: var(--danger);
      border: 1px solid var(--danger);
      box-shadow: none;
      width: auto;
      padding: 8px 16px;
      font-size: 13px;
    }

    button.danger:hover {
      background: var(--danger-bg);
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.2);
    }

    button.edit {
      background: var(--border);
      color: var(--text);
      width: auto;
      padding: 8px 16px;
      font-size: 13px;
      margin-right: 8px;
      box-shadow: none;
    }

    .hidden {
      display: none !important;
    }

    /* List Styles */
    #memoList li,
    #exerciseList li {
      background: var(--card-bg);
      border: 1px solid var(--border);
      padding: 24px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s;
    }

    #memoList li:hover {
      border-color: var(--primary);
      transform: translateX(4px);
    }

    .memo-content {
      flex: 1;
    }

    .memo-meta {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }

    .memo-main {
      font-size: 20px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: 0.5px;
    }

    .memo-main span {
      color: var(--primary);
    }

    .memo-note {
      font-size: 14px;
      margin-top: 8px;
      color: var(--text-muted);
      background: #0f172a;
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 2px solid var(--border);
    }

    /* Filters (Segmented Control) */
    .filter-group {
      display: inline-flex;
      background: #0f172a;
      padding: 4px;
      border-radius: var(--radius-md);
      margin-bottom: 24px;
      gap: 4px;
      border: 1px solid var(--border);
    }

    .filter-option {
      padding: 8px 16px;
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.2s;
      user-select: none;
      display: flex;
      align-items: center;
      margin: 0;
    }

    .filter-option:hover {
      color: var(--text);
      background: rgba(255, 255, 255, 0.05);
    }

    .filter-option.active {
      background: var(--card-bg);
      color: var(--primary);
      border: 1px solid var(--primary);
      box-shadow: 0 0 10px rgba(175, 252, 65, 0.1);
    }

    .filter-option input {
      display: none;
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: #0f172a;
      padding: 4px;
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
      border: none;
    }

    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .tab.active {
      background: var(--card-bg);
      color: var(--primary);
      box-shadow: none;
      border: 1px solid var(--primary);
      border-bottom: none;
      margin-bottom: 0;
    }

    /* Login Screen */
    .login-wrapper {
      background: #0f172a;
      background-image: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);
    }

    .auth-container .card {
      padding: 40px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      background: rgba(30, 41, 59, 0.95);
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
    }

    .mobile-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--sidebar-bg);
      border-top: 1px solid var(--border);
      height: 64px;
      z-index: 1000;
      justify-content: space-around;
      align-items: center;
      padding: 0 5px;
      /* 6é …ç›®ã®ãŸã‚ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
    }

    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: var(--text-muted);
      font-size: 9px;
      /* å°‘ã—å°ã•ã */
      cursor: pointer;
      gap: 2px;
      /* å°‘ã—è©°ã‚ã‚‹ */
      flex: 1;
      /* å„é …ç›®ãŒç­‰å¹…ã«ãªã‚‹ã‚ˆã†ã« */
      min-width: 0;
    }

    .mobile-nav-item.active {
      color: var(--primary);
    }

    .mobile-nav-item .material-symbols-outlined {
      font-size: 22px;
      /* å°‘ã—å°ã•ã */
      margin-right: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        display: none;
      }

      .mobile-nav {
        display: flex;
      }

      .main-content {
        padding: 20px 16px 100px 16px;
        width: 100%;
        box-sizing: border-box;
      }

      .card {
        padding: 20px 16px;
      }

      h1 {
        font-size: 2em;
      }

      h2 {
        font-size: 1.5em;
      }

      .filter-group {
        display: flex;
        overflow-x: auto;
        width: 100%;
      }

      .filter-option {
        flex-shrink: 0;
        white-space: nowrap;
      }
    }
  </style>
</head>

<body>

  <!-- PWA Install Prompt -->
  <div id="installPrompt"
    style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; background: linear-gradient(135deg, var(--primary), var(--accent)); padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 32px rgba(175, 252, 65, 0.3); max-width: 90%; animation: slideUp 0.3s ease;">
    <div style="display: flex; align-items: center; gap: 12px;">
      <span class="material-symbols-outlined" style="font-size: 32px; color: #000;">install_mobile</span>
      <div style="flex: 1;">
        <div style="font-weight: bold; color: #000; margin-bottom: 4px;">KinAppã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</div>
        <div style="font-size: 0.85em; color: #0f172a;">ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã—ã¦ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«ä½¿ãˆã¾ã™</div>
      </div>
      <button onclick="installPWA()"
        style="background: #0f172a; color: var(--accent); border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer;">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
      <button onclick="dismissInstallPrompt()"
        style="background: transparent; border: none; color: #000; cursor: pointer; padding: 8px;">
        <span class="material-symbols-outlined">close</span>
      </button>
    </div>
  </div>

  <!-- èªè¨¼ç”»é¢ (ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²) -->
  <div id="authSection" class="login-wrapper">
    <div class="auth-container">
      <div class="card">
        <h1 style="text-align:center;">ğŸ’ª Traning Memo</h1>
        <div class="tabs">
          <div class="tab active" onclick="showAuthTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</div>
          <div class="tab" onclick="showAuthTab('register')">æ–°è¦ç™»éŒ²</div>
        </div>

        <div id="loginFormContainer">
          <form id="loginForm">
            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
            <input type="text" id="loginUsername" required placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="loginPassword" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <p id="loginError" style="color: var(--danger); font-weight: bold; margin-top: 10px; display: none;"></p>
          </form>
        </div>

        <div id="registerFormContainer" class="hidden">
          <form id="registerForm">
            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å (æ–°è¦)</label>
            <input type="text" id="regUsername" required placeholder="å¸Œæœ›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="regPassword" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (1æ–‡å­—ä»¥ä¸Š)">
            <button type="submit">ç™»éŒ²ã™ã‚‹</button>
            <p id="regError" style="color: var(--danger); font-weight: bold; margin-top: 10px; display: none;"></p>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªãƒ¡ã‚¤ãƒ³ç”»é¢ -->
  <div id="appSection" class="hidden" style="width: 100%; display: flex;">
    <!-- ã‚µã‚¤ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (PC) -->
    <div class="sidebar">
      <h1 style="display: flex; align-items: center;"><span class="material-symbols-outlined"
          style="font-size: 1.2em;">fitness_center</span>KinApp</h1>
      <div class="menu-item active" onclick="switchPage('record')"><span
          class="material-symbols-outlined">edit_note</span>è¨˜éŒ²ã™ã‚‹</div>
      <div class="menu-item" onclick="switchPage('history')"><span class="material-symbols-outlined">history</span>å±¥æ­´ãƒ»æ¤œç´¢
      </div>
      <div class="menu-item" onclick="switchPage('meals')"><span class="material-symbols-outlined">restaurant</span>é£Ÿäº‹
      </div>
      <div class="menu-item" onclick="switchPage('weight')"><span
          class="material-symbols-outlined">monitor_weight</span>ä½“é‡
      </div>
      <div class="menu-item" onclick="switchPage('friends')"><span class="material-symbols-outlined">group</span>ãƒ•ãƒ¬ãƒ³ãƒ‰
      </div>
      <div class="menu-item" onclick="switchPage('settings')"><span class="material-symbols-outlined">settings</span>è¨­å®š
      </div>
      <div style="flex-grow: 1;"></div>
      <div style="margin-bottom: 10px; font-weight: bold; display: flex; align-items: center;"><span
          class="material-symbols-outlined">person</span><span id="currentUserDisplay"></span></div>
      <div class="menu-item" onclick="logout()" style="color: var(--danger);"><span
          class="material-symbols-outlined">logout</span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div>
    </div>

    <!-- ãƒ¢ãƒã‚¤ãƒ«ãƒœãƒˆãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="mobile-nav">
      <div class="mobile-nav-item active" onclick="switchPage('record')" id="m-nav-record">
        <span class="material-symbols-outlined">edit_note</span>
        <span>è¨˜éŒ²</span>
      </div>
      <div class="mobile-nav-item" onclick="switchPage('history')" id="m-nav-history">
        <span class="material-symbols-outlined">history</span>
        <span>å±¥æ­´</span>
      </div>
      <div class="mobile-nav-item" onclick="switchPage('meals')" id="m-nav-meals">
        <span class="material-symbols-outlined">restaurant</span>
        <span>é£Ÿäº‹</span>
      </div>
      <div class="mobile-nav-item" onclick="switchPage('weight')" id="m-nav-weight">
        <span class="material-symbols-outlined">monitor_weight</span>
        <span>ä½“é‡</span>
      </div>
      <div class="mobile-nav-item" onclick="switchPage('friends')" id="m-nav-friends">
        <span class="material-symbols-outlined">groups</span>
        <span>ãƒ•ãƒ¬ãƒ³ãƒ‰</span>
      </div>
      <div class="mobile-nav-item" onclick="switchPage('settings')" id="m-nav-settings" style="position: relative;">
        <span class="material-symbols-outlined">settings</span>
        <span>è¨­å®š</span>
        <div id="notifBadge" class="hidden"
          style="position: absolute; top: 5px; right: 15px; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid var(--sidebar-bg);">
        </div>
      </div>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">

      <!-- ãƒšãƒ¼ã‚¸: è¨˜éŒ² -->
      <div id="pageRecord" class="page-content">
        <h2>ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’è¨˜éŒ²</h2>
        <div class="card">
          <form id="memoForm">
            <input type="hidden" id="userId">

            <div style="display: flex; align-items: center; justify-content: space-between;">
              <label style="margin-bottom: 0;">æ—¥ä»˜ (ä»Šæ—¥ã¯éè¡¨ç¤ºä¸­)</label>
              <button type="button" class="secondary" onclick="toggleDateInput()"
                style="width: auto; padding: 4px 8px; font-size: 12px;">æ—¥ä»˜ã‚’å¤‰æ›´ã™ã‚‹</button>
            </div>
            <input type="date" id="date" required class="hidden" style="margin-top: 8px;">

            <label>ç¨®ç›®</label>
            <select id="exerciseSelect" onchange="checkExerciseCustom()" style="margin-bottom: 8px;">
              <option value="" disabled selected>ç¨®ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
            <input type="text" id="exerciseCustom" placeholder="ç¨®ç›®åã‚’å…¥åŠ›" class="hidden">

            <div style="display: flex; gap: 10px;">
              <div style="flex: 1;">
                <label>é‡é‡ (kg)</label>
                <input type="number" id="weight" step="0.5" required>
              </div>
              <div style="flex: 1;">
                <label>å›æ•° (reps)</label>
                <input type="number" id="reps" required>
              </div>
            </div>

            <label>ãƒ¡ãƒ¢</label>
            <input type="text" id="note" placeholder="æ„Ÿæƒ³ã‚„èª¿å­ãªã©">

            <button type="submit" id="submitBtn">ä¿å­˜ã™ã‚‹</button>
            <button type="button" id="cancelEditBtn" class="secondary hidden" onclick="cancelEdit()"
              style="margin-top: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </form>
        </div>
      </div>

      <!-- ãƒšãƒ¼ã‚¸: å±¥æ­´ -->
      <div id="pageHistory" class="page-content hidden">
        <h2>å±¥æ­´ & æ¤œç´¢</h2>
        <div class="card">
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="searchExercise" placeholder="ç¨®ç›®ã§æ¤œç´¢..." style="margin-bottom: 0;">
            <button onclick="searchMemos()" style="width: auto;">æ¤œç´¢</button>
          </div>

          <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆã‚¹ã‚¤ãƒƒãƒ (Segmented Control) -->
          <div class="filter-group">
            <label class="filter-option active" id="filterMineLabel">
              <input type="radio" name="viewFilter" value="mine" checked onchange="updateFilterUI()">
              è‡ªåˆ†ã®ã¿
            </label>
            <label class="filter-option" id="filterFriendsLabel">
              <input type="radio" name="viewFilter" value="friends" onchange="updateFilterUI()">
              ãƒ•ãƒ¬ãƒ³ãƒ‰ (ãƒ•ã‚©ãƒ­ãƒ¼ä¸­)
            </label>
            <label class="filter-option" id="filterAllLabel">
              <input type="radio" name="viewFilter" value="all" onchange="updateFilterUI()">
              å…¨å“¡ã®è¨˜éŒ²
            </label>
          </div>

          <button onclick="loadMemos()" class="secondary" style="margin-bottom: 10px;">ãƒªãƒ­ãƒ¼ãƒ‰ / å…¨ä»¶è¡¨ç¤º</button>

          <ul id="memoList"></ul>
        </div>
      </div>

      <!-- ãƒšãƒ¼ã‚¸: é£Ÿäº‹ç®¡ç† -->
      <div id="pageMeals" class="page-content hidden">
        <h2>é£Ÿäº‹ã®è¨˜éŒ²</h2>

        <!-- é£Ÿäº‹å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="card">
          <label>æ—¥ä»˜</label>
          <input type="date" id="mealDate">

          <label>é£Ÿäº‹ã‚¿ã‚¤ãƒ—</label>
          <select id="mealType">
            <option value="Breakfast">æœé£Ÿ</option>
            <option value="Lunch">æ˜¼é£Ÿ</option>
            <option value="Dinner">å¤•é£Ÿ</option>
            <option value="Snack">é–“é£Ÿ</option>
          </select>

          <label>é£Ÿã¹ãŸã‚‚ã® (AIæ¨å®šæ©Ÿèƒ½ä»˜ã)</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="foodName" placeholder="ä¾‹: ç‰›ä¸¼, ãƒãƒŠãƒŠ, ãƒã‚­ãƒ³ã‚µãƒ©ãƒ€" style="margin-bottom:0;">
            <button onclick="estimateNutrition()" style="width: auto; background: var(--accent); color: #000;"><span
                class="material-symbols-outlined" style="margin-right: 4px;">auto_awesome</span>AIæ¨å®š</button>
          </div>
          <div id="estimateBadge" style="font-size: 11px; color: var(--accent); margin-bottom: 5px; display: none;">
          </div>

          <div id="aiAdviceBox"
            style="display:none; background: rgba(175, 252, 65, 0.1); border: 1px solid var(--accent); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
            <div
              style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--accent); font-weight: bold; font-size: 0.9em;">
              <span class="material-symbols-outlined" style="font-size: 18px;">lightbulb</span>AIã‚¢ãƒ‰ãƒã‚¤ã‚¹
            </div>
            <div id="aiAdviceText" style="font-size: 0.85em; margin-bottom: 8px; line-height: 1.4;"></div>
            <div id="aiBreakdownText" style="font-size: 0.75em; color: var(--text-muted); font-style: italic;"></div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <label>ã‚«ãƒ­ãƒªãƒ¼ (kcal)</label>
              <input type="number" id="mealCal" placeholder="0">
            </div>
            <div>
              <label>ã‚¿ãƒ³ãƒ‘ã‚¯è³ª (g)</label>
              <input type="number" step="0.1" id="mealPro" placeholder="0">
            </div>
            <div>
              <label>è„‚è³ª (g)</label>
              <input type="number" step="0.1" id="mealFat" placeholder="0">
            </div>
            <div>
              <label>ç‚­æ°´åŒ–ç‰© (g)</label>
              <input type="number" step="0.1" id="mealCarb" placeholder="0">
            </div>
          </div>

          <button onclick="addMeal()">è¨˜éŒ²ã™ã‚‹</button>
        </div>

        <div class="card">
          <h3>ä»Šæ—¥ã¯ã“ã‚Œã ã‘é£Ÿã¹ã¾ã—ãŸ</h3>
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
            <h1 id="scoreDisplay" style="font-size:3em; margin:0; text-shadow: 0 0 10px var(--accent);">--ç‚¹</h1>
            <div style="text-align: right;">
              <div style="font-size:0.9em; color:var(--text-light);">æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼</div>
              <div style="font-size:1.5em; font-weight:bold;" id="calProgressText">0 / 0 kcal</div>
            </div>
          </div>

          <!-- ã‚«ãƒ­ãƒªãƒ¼ãƒãƒ¼ -->
          <div style="background:#333; height:10px; border-radius:5px; overflow:hidden; margin-bottom: 20px;">
            <div id="calProgressBar" style="width:0%; height:100%; background:var(--accent); transition: width 0.5s;">
            </div>
          </div>

          <!-- ãƒãƒ£ãƒ¼ãƒˆã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®2ã‚«ãƒ©ãƒ  -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div style="position: relative; height: 200px;">
              <canvas id="pfcChart"></canvas>
            </div>
            <div style="display: flex; flex-direction: column; justify-content: center;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h4 style="margin: 0;">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã®åŠ©è¨€</h4>
                <button onclick="getDailyAIAdvice()"
                  style="width: auto; padding: 6px 12px; font-size: 11px; background: var(--accent); color: #000; border-radius: 20px;">
                  <span class="material-symbols-outlined"
                    style="font-size: 14px; margin-right: 4px;">psychology</span>AIã«èã
                </button>
              </div>
              <div id="adviceDisplay"
                style="font-size: 0.9em; line-height: 1.5; color: #fff; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
                ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
              </div>
            </div>
          </div>

          <ul id="mealList" style="padding: 0; list-style: none; margin-top: 20px;"></ul>
        </div>
      </div>

      <!-- ãƒšãƒ¼ã‚¸: ä½“é‡ç®¡ç† -->
      <div id="pageWeight" class="page-content hidden">
        <h2>ä½“é‡ç®¡ç†</h2>
        <div class="card">
          <label>æ—¥ä»˜</label>
          <input type="date" id="weightDate">
          <label>ä½“é‡ (kg)</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="number" step="0.1" id="weightInput" placeholder="0.0" style="margin-bottom:0;">
            <button onclick="addWeight()" style="width: auto;">è¨˜éŒ²ã™ã‚‹</button>
          </div>
        </div>

        <div class="card">
          <h3>ä½“é‡æ¨ç§»</h3>
          <div style="position: relative; height: 300px; margin-bottom: 20px;">
            <canvas id="weightChart"></canvas>
          </div>
          <div id="weightSummary" style="font-size: 0.9em; color: var(--text-muted);">
            è¨˜éŒ²ã‚’èª­ã¿è¾¼ã¿ä¸­...
          </div>
        </div>
      </div>

      <!-- ãƒšãƒ¼ã‚¸: ãƒ•ãƒ¬ãƒ³ãƒ‰ -->
      <div id="pageFriends" class="page-content hidden">
        <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ç®¡ç†</h2>
        <div class="card">
          <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="userSearchInput" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›" style="margin-bottom: 0;">
            <button onclick="searchUsers()" style="width: auto;">æ¤œç´¢</button>
          </div>
          <ul id="useruSearchResults" style="margin-top: 10px; padding: 0; list-style: none;"></ul>
        </div>

        <div class="card">
          <h3>ãƒ•ã‚©ãƒ­ãƒ¼ä¸­ <span id="followingCount">(0)</span></h3>
          <ul id="followingList" style="padding: 0; list-style: none;"></ul>
        </div>

        <div class="card">
          <h3>ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼ (ã‚ãªãŸã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã‚‹äºº) <span id="followersCount">(0)</span></h3>
          <ul id="followersList" style="padding: 0; list-style: none;"></ul>
        </div>
      </div>

      <!-- ãƒšãƒ¼ã‚¸: è¨­å®š (ç¨®ç›®è¨­å®šå«ã‚€) -->
      <div id="pageSettings" class="page-content hidden">
        <h2>è¨­å®š</h2>

        <div class="card">
          <h3>å…¬é–‹è¨­å®š</h3>
          <p style="color: var(--text-muted); margin-bottom: 15px;">ã‚ãªãŸã®è¨˜éŒ²ã‚’èª°ã«è¦‹ã›ã‚‹ã‹è¨­å®šã—ã¾ã™ã€‚</p>
          <div class="filter-group" style="margin-bottom: 20px;">
            <label class="filter-option" id="visPublic">
              <input type="radio" name="visibility" value="public" onchange="updateVisibilitySetting()"> å…¨ä½“å…¬é–‹
            </label>
            <label class="filter-option" id="visFriends">
              <input type="radio" name="visibility" value="friends" onchange="updateVisibilitySetting()"> ãƒ•ãƒ¬ãƒ³ãƒ‰ã®ã¿
            </label>
            <label class="filter-option" id="visPrivate">
              <input type="radio" name="visibility" value="private" onchange="updateVisibilitySetting()"> éå…¬é–‹
            </label>
          </div>
        </div>

        <div class="card">
          <h3>ç›®æ¨™è¨­å®š (1æ—¥ã‚ãŸã‚Š)</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <div><label>ã‚«ãƒ­ãƒªãƒ¼ (kcal)</label><input type="number" id="targetCal" placeholder="2000"></div>
            <div><label>ã‚¿ãƒ³ãƒ‘ã‚¯è³ª (g)</label><input type="number" id="targetPro" placeholder="60"></div>
            <div>
              <div><label>è„‚è³ª (g)</label><input type="number" id="targetFat" placeholder="60"></div>
              <div><label>ç‚­æ°´åŒ–ç‰© (g)</label><input type="number" id="targetCarb" placeholder="300"></div>
            </div>
            <button onclick="saveTargets()">ç›®æ¨™ã‚’ä¿å­˜</button>
          </div>

          <div class="card">
            <h3>ç¨®ç›®ã®ç®¡ç†</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;">
              ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¡¨ç¤ºã™ã‚‹ç¨®ç›®ã‚’è¿½åŠ ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚
            </p>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
              <input type="text" id="newExerciseName" placeholder="æ–°ã—ã„ç¨®ç›®ã‚’è¿½åŠ " style="margin-bottom: 0;">
              <button onclick="addExercise()" style="width: auto;">è¿½åŠ </button>
            </div>

            <ul id="exerciseList" style="list-style: none; padding: 0;">
              <!-- JSã§æç”» -->
            </ul>
          </div>
        </div>

      </div>
    </div>

    <script>
      const apiBase = '';
      let editingId = null;
      let currentUser = localStorage.getItem('kin_user');
      let allExercises = []; // ç¨®ç›®ãƒªã‚¹ãƒˆã‚’ä¿æŒ
      let currentDayMeals = []; // ä»Šæ—¥ã®é£Ÿäº‹ãƒªã‚¹ãƒˆã‚’ä¿æŒ (AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”¨)

      // åˆæœŸåŒ–å‡¦ç†
      if (currentUser) {
        showApp(currentUser);
      } else {
        showAuth();
      }

      // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
      function showAuthTab(tab) {
        const loginDiv = document.getElementById('loginFormContainer');
        const regDiv = document.getElementById('registerFormContainer');
        const tabs = document.querySelectorAll('.tab');

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('loginError').style.display = 'none';
        document.getElementById('regError').style.display = 'none';

        if (tab === 'login') {
          loginDiv.classList.remove('hidden');
          regDiv.classList.add('hidden');
          tabs[0].classList.add('active');
          tabs[1].classList.remove('active');
        } else {
          loginDiv.classList.add('hidden');
          regDiv.classList.remove('hidden');
          tabs[0].classList.remove('active');
          tabs[1].classList.add('active');
        }
      }

      function showApp(username) {
        try {
          console.log('showApp called for:', username);
          currentUser = username;
          localStorage.setItem('kin_user', username);

          const authSec = document.getElementById('authSection');
          const appSec = document.getElementById('appSection');

          // ã‚¯ãƒ©ã‚¹æ“ä½œã ã‘ã§ãªãã€ç›´æ¥ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›¸ãæ›ãˆã¦ç¢ºå®Ÿã«è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
          if (authSec) {
            authSec.classList.add('hidden');
            authSec.style.display = 'none'; // å¼·åˆ¶éè¡¨ç¤º
            console.log('authSection hidden');
          }

          if (appSec) {
            appSec.classList.remove('hidden');
            appSec.style.display = 'flex'; // å¼·åˆ¶è¡¨ç¤º
            console.log('appSection shown');
          }

          document.getElementById('currentUserDisplay').textContent = username;

          // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
          const dateEl = document.getElementById('date');
          if (dateEl) dateEl.valueAsDate = new Date();

          // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆç›®æ¨™å€¤å«ã‚€ï¼‰ã‚’å–å¾—
          loadUserInfo();

          loadExercises();
          loadMemos();
          switchPage('record'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è¨˜éŒ²ãƒšãƒ¼ã‚¸

          // é€šçŸ¥ãƒãƒ¼ãƒªãƒ³ã‚°ã®é–‹å§‹
          setInterval(loadNotifications, 30000); // 30ç§’ã”ã¨
          loadNotifications();

        } catch (e) {
          console.error("Critical Error in showApp:", e);
          alert("ã‚¢ãƒ—ãƒªã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
        }
      }

      function showAuth() {
        currentUser = null;
        localStorage.removeItem('kin_user');
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('appSection').classList.add('hidden');
      }

      function logout() {
        if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
          showAuth();
        }
      }

      // --- ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ ---
      // --- ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ ---
      function switchPage(pageId) {
        // å…¨ã¦ã®ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éš ã™
        document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));

        // å¯¾è±¡ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const targetPageId = 'page' + pageId.charAt(0).toUpperCase() + pageId.slice(1);
        const targetPage = document.getElementById(targetPageId);
        if (targetPage) {
          targetPage.classList.remove('hidden');
          targetPage.classList.add('fade-in');
        }

        // PCãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ´»æ€§åŒ–
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        const pcMenuItem = Array.from(document.querySelectorAll('.menu-item')).find(m => m.getAttribute('onclick')?.includes(`'${pageId}'`));
        if (pcMenuItem) pcMenuItem.classList.add('active');

        // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®æ´»æ€§åŒ–
        document.querySelectorAll('.mobile-nav-item').forEach(m => m.classList.remove('active'));
        const mobNavId = 'm-nav-' + pageId;
        if (document.getElementById(mobNavId)) {
          document.getElementById(mobNavId).classList.add('active');
        }

        // ãƒšãƒ¼ã‚¸ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        if (pageId === 'history') loadMemos();
        if (pageId === 'meals') {
          const d = new Date();
          const mealDateInput = document.getElementById('mealDate');
          if (mealDateInput && !mealDateInput.value) mealDateInput.valueAsDate = d;
          loadMeals();
        }
        if (pageId === 'weight') {
          const weightDateInput = document.getElementById('weightDate');
          if (weightDateInput) weightDateInput.valueAsDate = new Date();
          loadWeightHistory();
        }
        if (pageId === 'friends') loadFriends();
        if (pageId === 'settings') {
          loadSettings();
          loadExerciseList();
          markNotifsRead(); // é€šçŸ¥ã‚’æ—¢èª­ã«ã™ã‚‹
        }
      }

      function updateFilterUI() {
        const filterInput = document.querySelector('input[name="viewFilter"]:checked');
        if (!filterInput) return;
        const filter = filterInput.value;
        const mineLabel = document.getElementById('filterMineLabel');
        const friendsLabel = document.getElementById('filterFriendsLabel');
        const allLabel = document.getElementById('filterAllLabel');

        if (mineLabel) mineLabel.classList.remove('active');
        if (friendsLabel) friendsLabel.classList.remove('active');
        if (allLabel) allLabel.classList.remove('active');

        if (filter === 'mine' && mineLabel) mineLabel.classList.add('active');
        else if (filter === 'friends' && friendsLabel) friendsLabel.classList.add('active');
        else if (allLabel) allLabel.classList.add('active');

        loadMemos();
      }

      // --- APIé€£æº: ç¨®ç›®ç®¡ç† ---
      async function loadExercises() {
        const res = await fetch(`${apiBase}/exercises`);
        allExercises = await res.json();
        renderExerciseSelect();
        renderExerciseList();
      }

      function renderExerciseSelect() {
        const select = document.getElementById('exerciseSelect');
        // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢ï¼ˆ"custom"ãªã©ã¯æ®‹ã•ãªã„ã¨ã„ã‘ãªã„ãŒå†æ§‹ç¯‰ã™ã‚‹ï¼‰

        allExercises.forEach(ex => {
          const opt = document.createElement('option');
          opt.value = ex.name;
          opt.textContent = ex.name;
          select.appendChild(opt);
        });

        // ãã®ä»–ã‚’è¿½åŠ 
        const customOpt = document.createElement('option');
        customOpt.value = 'custom';
        customOpt.textContent = 'ãã®ä»– (æ‰‹å…¥åŠ›)';
        select.appendChild(customOpt);
      }

      function renderExerciseList() {
        const list = document.getElementById('exerciseList');
        list.innerHTML = '';
        allExercises.forEach(ex => {
          const li = document.createElement('li');
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.padding = '8px';
          li.style.borderBottom = '1px solid #eee';

          li.innerHTML = `
            <span>${ex.name}</span>
            <button class="danger" onclick="deleteExercise(${ex.id})" style="padding: 2px 8px; font-size: 12px;">å‰Šé™¤</button>
          `;
          list.appendChild(li);
        })
      }

      async function addExercise() {
        const name = document.getElementById('newExerciseName').value;
        if (!name) return;

        const res = await fetch(`${apiBase}/exercises`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });

        if (res.ok) {
          document.getElementById('newExerciseName').value = '';
          loadExercises(); // ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ 
        } else {
          const err = await res.json();
          alert('è¿½åŠ å¤±æ•—: ' + err.detail);
        }
      }

      async function deleteExercise(id) {
        if (!confirm('ã“ã®ç¨®ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆéå»ã®è¨˜éŒ²ã¯æ¶ˆãˆã¾ã›ã‚“ãŒã€é¸æŠè‚¢ã‹ã‚‰ãªããªã‚Šã¾ã™ï¼‰')) return;

        await fetch(`${apiBase}/exercises/${id}`, { method: 'DELETE' })
          .then(res => {
            if (res.ok) {
              loadExercises();
            } else {
              alert('å‰Šé™¤å¤±æ•—');
            }
          });
      }


      // --- APIé€£æº: èªè¨¼ ---

      document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('regUsername').value;
        const password = document.getElementById('regPassword').value;
        const errDisplay = document.getElementById('regError');

        // ãƒªã‚»ãƒƒãƒˆ
        errDisplay.style.display = 'none';
        errDisplay.textContent = '';

        const res = await fetch(`${apiBase}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          alert("ç™»éŒ²æˆåŠŸï¼ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
          showAuthTab('login');
          document.getElementById('loginUsername').value = username;
          document.getElementById('registerForm').reset();
        } else {
          const result = await res.json();
          // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
          errDisplay.textContent = result.detail;
          errDisplay.style.display = 'block';
        }
      });

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const errDisplay = document.getElementById('loginError');

        // ãƒªã‚»ãƒƒãƒˆ
        errDisplay.style.display = 'none';
        errDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­...';
        errDisplay.style.color = 'black';
        errDisplay.style.display = 'block';

        try {
          // ç°¡æ˜“çš„ãªãƒ­ã‚°ã‚¤ãƒ³APIå‘¼ã³å‡ºã—
          const res = await fetch(`${apiBase}/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
          });

          if (res.ok) {
            errDisplay.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™...';
            console.log('Login successful for:', username);
            setTimeout(() => {
              showApp(username);
              document.getElementById('loginForm').reset();
            }, 500);
          } else {
            const result = await res.json();
            errDisplay.style.color = 'var(--danger)';
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰ãˆã‚‹ãªã©)
            if (res.status === 400 || res.status === 401) {
              errDisplay.textContent = result.detail || "ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“";
            } else {
              errDisplay.textContent = "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ Status:" + res.status;
            }
          }
        } catch (error) {
          console.error(error);
          errDisplay.style.color = 'var(--danger)';
          errDisplay.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
        }
      });

      function checkExerciseCustom() {
        const select = document.getElementById('exerciseSelect');
        const customInput = document.getElementById('exerciseCustom');

        if (select.value === 'custom') {
          customInput.classList.remove('hidden');
          customInput.required = true;
          customInput.focus();
        } else {
          customInput.classList.add('hidden');
          customInput.required = false;
        }
      }

      function getSelectedExercise() {
        const select = document.getElementById('exerciseSelect');
        if (select.value === 'custom') {
          return document.getElementById('exerciseCustom').value;
        }
        return select.value;
      }

      // --- APIé€£æº: ãƒ¡ãƒ¢æ©Ÿèƒ½ ---

      document.getElementById('memoForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const exerciseName = getSelectedExercise();
        if (!exerciseName) {
          alert("ç¨®ç›®ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        const data = {
          user_id: currentUser,
          date: document.getElementById('date').value,
          exercise: exerciseName,
          weight: parseFloat(document.getElementById('weight').value),
          reps: parseInt(document.getElementById('reps').value),
          note: document.getElementById('note').value,
        };

        let url = `${apiBase}/memo`;
        let method = 'POST';

        if (editingId !== null) {
          url = `${apiBase}/memo/${editingId}`;
          method = 'PUT';
        }

        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert(method === 'POST' ? 'ä¿å­˜ã—ã¾ã—ãŸï¼' : 'æ›´æ–°ã—ã¾ã—ãŸï¼');
          resetForm();
          loadMemos();
        } else {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      });

      async function loadMemos() {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šã‚’ç¢ºèª
        const filter = document.querySelector('input[name="viewFilter"]:checked').value;

        // V2 APIã‚’ä½¿ç”¨
        let url = `${apiBase}/memo_v2?viewer_id=${encodeURIComponent(currentUser)}&filter_mode=${filter}`;
        const res = await fetch(url);
        const memos = await res.json();
        renderList(memos);
      }

      async function searchMemos() {
        const exercise = document.getElementById('searchExercise').value;
        const filter = document.querySelector('input[name="viewFilter"]:checked').value;

        let url = `${apiBase}/memo_v2?viewer_id=${encodeURIComponent(currentUser)}&filter_mode=${filter}&exercise=${encodeURIComponent(exercise)}`;
        const res = await fetch(url);
        const memos = await res.json();
        renderList(memos);
      }

      function renderList(memos) {
        const list = document.getElementById('memoList');
        list.innerHTML = '';

        // æ–°ã—ã„é †ã«
        memos.slice().reverse().forEach((m) => {
          const isMine = (m.user_id === currentUser);
          const li = document.createElement('li');

          // ä»–äººã®è¨˜éŒ²ãªã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤ºã€è‡ªåˆ†ãªã‚‰ç·¨é›†ãƒœã‚¿ãƒ³ãªã©
          let userBadge = '';
          if (!isMine) {
            userBadge = `<span style="font-size: 12px; background: #e5e7eb; padding: 2px 6px; border-radius: 4px; margin-right: 6px;">ğŸ‘¤ ${m.user_id}</span>`;
          }

          let actionButtons = '';
          if (isMine) {
            actionButtons = `
            <button class="edit" onclick="editMemo(${m.id})">ç·¨é›†</button>
            <button class="danger" onclick="deleteMemo(${m.id})">å‰Šé™¤</button>
            `;
          }

          li.innerHTML = `
        <div class="memo-content">
          <div class="memo-meta">${userBadge}${m.date}</div>
          <div class="memo-main">${m.exercise} ${m.weight}kg Ã— ${m.reps}å›</div>
          <div class="memo-note">${m.note}</div>
        </div>
        <div class="memo-actions">
          ${actionButtons}
        </div>
      `;
          list.appendChild(li);
        });
      }

      function editMemo(id) {
        fetch(`${apiBase}/memo?id=${id}`)
          .then(res => res.json())
          .then(memos => {
            const m = memos[0];
            if (m) {
              document.getElementById('date').value = m.date;
              // ç·¨é›†æ™‚ã¯æ—¥ä»˜ãŒè¦‹ãˆãŸã»ã†ãŒè¦ªåˆ‡ãªã®ã§è¡¨ç¤ºã™ã‚‹
              document.getElementById('date').classList.remove('hidden');

              // ç¨®ç›®ã®ã‚»ãƒƒãƒˆï¼ˆãƒªã‚¹ãƒˆã«ã‚ã‚‹ã‹ç¢ºèªï¼‰
              const select = document.getElementById('exerciseSelect');
              const customInput = document.getElementById('exerciseCustom');
              const options = Array.from(select.options).map(o => o.value);

              if (options.includes(m.exercise)) {
                select.value = m.exercise;
                customInput.classList.add('hidden');
              } else {
                select.value = 'custom';
                customInput.value = m.exercise;
                customInput.classList.remove('hidden');
              }

              document.getElementById('weight').value = m.weight;
              document.getElementById('reps').value = m.reps;
              document.getElementById('note').value = m.note;

              editingId = id;
              document.getElementById('submitBtn').textContent = "æ›´æ–°ã™ã‚‹";
              document.getElementById('cancelEditBtn').classList.remove('hidden');

              // è¨˜éŒ²ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
              switchPage('record');

              // ãƒ•ã‚©ãƒ¼ãƒ ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
              document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
            }
          });
      }

      function deleteMemo(id) {
        if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          fetch(`${apiBase}/memo/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(() => {
              loadMemos();
            });
        }
      }

      function cancelEdit() {
        resetForm();
      }

      function resetForm() {
        editingId = null;
        document.getElementById('submitBtn').textContent = "ä¿å­˜ã™ã‚‹";
        document.getElementById('cancelEditBtn').classList.add('hidden');

        // æ—¥ä»˜ã¯ä»Šæ—¥ã«æˆ»ã—ã¦éš ã™
        document.getElementById('memoForm').reset();
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('date').classList.add('hidden');

        // ç¨®ç›®é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('exerciseCustom').classList.add('hidden');
      }


      // --- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒ»è¨­å®šæ©Ÿèƒ½ ---

      async function searchUsers() {
        const q = document.getElementById('userSearchInput').value;
        if (!q) return;
        const res = await fetch(`${apiBase}/users/search?q=${encodeURIComponent(q)}`);
        const users = await res.json();

        // ãƒ•ã‚©ãƒ­ãƒ¼çŠ¶æ³ã‚’å–å¾—ã—ã¦ãƒœã‚¿ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã®æº–å‚™
        const fRes = await fetch(`${apiBase}/friends?current_user=${encodeURIComponent(currentUser)}`);
        const fData = await fRes.json();
        const following = fData.following;

        const ul = document.getElementById('useruSearchResults');
        ul.innerHTML = '';
        users.forEach(u => {
          if (u === currentUser) return; // è‡ªåˆ†ã¯è¡¨ç¤ºã—ãªã„
          const isFollowing = following.includes(u);
          const li = document.createElement('li');
          li.style.padding = '8px';
          li.style.borderBottom = '1px solid var(--border)';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.style.alignItems = 'center';
          li.innerHTML = `
                <span>${u}</span>
                ${isFollowing ?
              `<span style="font-size:12px; color:var(--primary);">ãƒ•ã‚©ãƒ­ãƒ¼ä¸­</span>` :
              `<button onclick="addFriend('${u}')" class="edit" style="width:auto; font-size:12px;">ãƒ•ã‚©ãƒ­ãƒ¼</button>`
            }
            `;
          ul.appendChild(li);
        });
      }

      async function addFriend(username) {
        const res = await fetch(`${apiBase}/friends?current_user=${encodeURIComponent(currentUser)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ friend_username: username })
        });
        if (res.ok) {
          alert(username + ' ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã—ãŸ');
          loadFriends();
          searchUsers(); // ãƒªãƒ­ãƒ¼ãƒ‰
        } else {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      }

      async function loadNotifications() {
        if (!currentUser) return;
        const res = await fetch(`${apiBase}/notifications?current_user=${encodeURIComponent(currentUser)}`);
        const data = await res.json();

        const hasUnread = data.some(n => !n.is_read);
        const badge = document.getElementById('notifBadge');
        if (badge) {
          if (hasUnread) badge.classList.remove('hidden');
          else badge.classList.add('hidden');
        }

        const list = document.getElementById('notifList');
        if (list) {
          list.innerHTML = '';
          if (data.length === 0) {
            list.innerHTML = '<li style="color:var(--text-muted); font-size:14px; padding:10px;">ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
          }
          data.forEach(n => {
            const li = document.createElement('li');
            li.style.padding = '12px 10px';
            li.style.borderBottom = '1px solid var(--border)';
            li.style.fontSize = '14px';
            li.style.background = n.is_read ? 'transparent' : 'rgba(175, 252, 65, 0.05)';

            let msg = '';
            if (n.type === 'follow') {
              msg = `<strong>${n.from_user}</strong> ã•ã‚“ã«ãƒ•ã‚©ãƒ­ãƒ¼ã•ã‚Œã¾ã—ãŸï¼`;
            }

            const dateStr = new Date(n.created_at).toLocaleString('ja-JP', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            li.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                  <span>${msg}</span>
                  <span style="font-size:10px; color:var(--text-muted);">${dateStr}</span>
                </div>
              `;
            list.appendChild(li);
          });
        }
      }

      async function markNotifsRead() {
        await fetch(`${apiBase}/notifications/read?current_user=${encodeURIComponent(currentUser)}`, { method: 'POST' });
        loadNotifications();
      }

      async function loadFriends() {
        const res = await fetch(`${apiBase}/friends?current_user=${encodeURIComponent(currentUser)}`);
        const data = await res.json();

        document.getElementById('followingCount').textContent = `(${data.following.length})`;
        document.getElementById('followersCount').textContent = `(${data.followers.length})`;

        const followingList = document.getElementById('followingList');
        followingList.innerHTML = '';
        data.following.forEach(u => {
          const li = document.createElement('li');
          li.style.padding = '8px';
          li.style.borderBottom = '1px solid var(--border)';
          li.style.display = 'flex';
          li.style.justifyContent = 'space-between';
          li.innerHTML = `<span>${u}</span> <button class="danger" onclick="removeFriend('${u}')" style="width:auto; font-size:12px;">è§£é™¤</button>`;
          followingList.appendChild(li);
        });

        const followersList = document.getElementById('followersList');
        followersList.innerHTML = '';
        data.followers.forEach(u => {
          const li = document.createElement('li');
          li.style.padding = '8px';
          li.style.borderBottom = '1px solid var(--border)';
          li.innerHTML = `<span>${u}</span>`;
          followersList.appendChild(li);
        });
      }

      async function removeFriend(username) {
        if (!confirm(username + ' ã®ãƒ•ã‚©ãƒ­ãƒ¼ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const res = await fetch(`${apiBase}/friends/${username}?current_user=${encodeURIComponent(currentUser)}`, {
          method: 'DELETE'
        });
        if (res.ok) loadFriends();
      }

      async function updateVisibilitySetting() {
        const val = document.querySelector('input[name="visibility"]:checked').value;
        const labels = ['visPublic', 'visFriends', 'visPrivate'];
        labels.forEach(id => document.getElementById(id).classList.remove('active'));

        if (val === 'public') document.getElementById('visPublic').classList.add('active');
        if (val === 'friends') document.getElementById('visFriends').classList.add('active');
        if (val === 'private') document.getElementById('visPrivate').classList.add('active');

        await fetch(`${apiBase}/settings/visibility?current_user=${encodeURIComponent(currentUser)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ visibility: val })
        });
      }

      // --- é£Ÿäº‹ç®¡ç†æ©Ÿèƒ½ ---

      async function estimateNutrition() {
        const text = document.getElementById('foodName').value;
        if (!text) return alert("é£Ÿã¹ç‰©ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const btn = document.querySelector('button[onclick="estimateNutrition()"]');
        btn.textContent = "è€ƒãˆä¸­...";
        btn.disabled = true;

        try {
          const res = await fetch(`${apiBase}/api/estimate_nutrition`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
          });

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.detail || "æ¨å®šã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          document.getElementById('mealCal').value = data.calories || 0;
          document.getElementById('mealPro').value = data.protein || 0;
          document.getElementById('mealFat').value = data.fat || 0;
          document.getElementById('mealCarb').value = data.carbs || 0;

          const badge = document.getElementById('estimateBadge');
          badge.style.display = 'block';
          badge.textContent = `ã‚½ãƒ¼ã‚¹: ${data.source} (${data.food_name})`;

          // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¨å†…è¨³ã®è¡¨ç¤º
          if (data.advice || data.breakdown) {
            document.getElementById('aiAdviceBox').style.display = 'block';
            document.getElementById('aiAdviceText').textContent = data.advice || '';
            document.getElementById('aiBreakdownText').textContent = data.breakdown ? `ã€æ¨å®šã®å†…è¨³ã€‘: ${data.breakdown}` : '';
          } else {
            document.getElementById('aiAdviceBox').style.display = 'none';
          }

        } catch (e) {
          alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
          console.error(e);
        } finally {
          btn.textContent = "ğŸª„ AIæ¨å®š";
          btn.disabled = false;
        }
      }

      async function addMeal() {
        const date = document.getElementById('mealDate').value;
        const type = document.getElementById('mealType').value;
        const name = document.getElementById('foodName').value;
        const cal = document.getElementById('mealCal').value;
        const p = document.getElementById('mealPro').value;
        const f = document.getElementById('mealFat').value;
        const c = document.getElementById('mealCarb').value;

        if (!name || !date) return alert("æ—¥ä»˜ã¨é£Ÿäº‹åã¯å¿…é ˆã§ã™");

        const body = {
          user_id: currentUser,
          date: date,
          meal_type: type,
          food_name: name,
          calories: parseInt(cal) || 0,
          protein: parseFloat(p) || 0,
          fat: parseFloat(f) || 0,
          carbs: parseFloat(c) || 0
        };

        const res = await fetch(`${apiBase}/meals`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (res.ok) {
          alert('é£Ÿäº‹ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
          // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
          document.getElementById('foodName').value = '';
          document.getElementById('mealCal').value = '';
          document.getElementById('mealPro').value = '';
          document.getElementById('mealFat').value = '';
          document.getElementById('mealCarb').value = '';
          document.getElementById('estimateBadge').style.display = 'none';
          document.getElementById('aiAdviceBox').style.display = 'none'; // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚‚æ¶ˆã™
          loadMeals();
        } else {
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        }
      }

      async function loadMeals() {
        const date = document.getElementById('mealDate').value;
        if (!date) return;

        const res = await fetch(`${apiBase}/meals?user_id=${encodeURIComponent(currentUser)}&date=${date}`);
        const meals = await res.json();
        currentDayMeals = meals; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜

        const list = document.getElementById('mealList');
        list.innerHTML = '';

        let totalCal = 0;
        let totalP = 0, totalF = 0, totalC = 0;

        meals.forEach(m => {
          totalCal += m.calories;
          totalP += m.protein;
          totalF += m.fat;
          totalC += m.carbs;

          const li = document.createElement('li');
          li.className = 'card';
          li.style.marginBottom = '10px';
          li.style.padding = '10px';
          li.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <span style="font-weight:bold; color:var(--accent); margin-right:5px;">${m.meal_type}</span>
                        <span style="font-weight:bold;">${m.food_name}</span>
                        <br>
                        <span style="font-size:0.9em; color:var(--text-light);">
                            ${m.calories}kcal (P:${m.protein}g F:${m.fat}g C:${m.carbs}g)
                        </span>
                    </div>
                    <button class="danger" onclick="deleteMeal(${m.id})" style="width:auto; padding:5px 10px;">å‰Šé™¤</button>
                </div>
            `;
          list.appendChild(li);
        });

        // ãƒãƒ£ãƒ¼ãƒˆãªã©ã‚’æ›´æ–°
        updateDashboard(totalCal, totalP, totalF, totalC);
      }

      // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›®æ¨™ç®¡ç†ãƒ»Dashboard ---
      let userTargets = { cal: 2000, p: 60, f: 60, c: 300 };
      let chartInstance = null;

      async function loadUserInfo() {
        const res = await fetch(`${apiBase}/users/me?current_user=${encodeURIComponent(currentUser)}`);
        const data = await res.json();
        if (data.target_calories) {
          userTargets = {
            cal: data.target_calories,
            p: data.target_protein,
            f: data.target_fat,
            c: data.target_carbs
          };

          // è¨­å®šç”»é¢ã«åæ˜ 
          document.getElementById('targetCal').value = userTargets.cal;
          document.getElementById('targetPro').value = userTargets.p;
          document.getElementById('targetFat').value = userTargets.f;
          document.getElementById('targetCarb').value = userTargets.c;

          // å…¬é–‹è¨­å®šã‚‚ã“ã“ã§åæ˜ ã§ãã‚‹ãŒã€å€‹åˆ¥APIã§ã‚„ã£ã¦ã‚‹ã®ã§å‰²æ„›ï¼ˆã‚‚ã—ãã¯çµ±åˆã—ã¦ã‚‚ã„ã„ï¼‰
        }
      }

      async function saveTargets() {
        const t = {
          target_calories: parseInt(document.getElementById('targetCal').value) || 2000,
          target_protein: parseFloat(document.getElementById('targetPro').value) || 60,
          target_fat: parseFloat(document.getElementById('targetFat').value) || 60,
          target_carbs: parseFloat(document.getElementById('targetCarb').value) || 300,
        };

        await fetch(`${apiBase}/settings/targets?current_user=${encodeURIComponent(currentUser)}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(t)
        });
        userTargets = { cal: t.target_calories, p: t.target_protein, f: t.target_fat, c: t.target_carbs };
        alert("ç›®æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
      }

      function updateDashboard(cal, p, f, c) {
        // ã‚«ãƒ­ãƒªãƒ¼ãƒãƒ¼
        const calPercent = Math.min((cal / userTargets.cal) * 100, 100);
        document.getElementById('calProgressBar').style.width = `${calPercent}%`;
        document.getElementById('calProgressText').textContent = `${cal} / ${userTargets.cal} kcal`;

        // è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆè¶…éã—ãŸã‚‰èµ¤ã¨ã‹ï¼‰
        if (cal > userTargets.cal) {
          document.getElementById('calProgressBar').style.backgroundColor = '#ff0055';
        } else {
          document.getElementById('calProgressBar').style.backgroundColor = 'var(--accent)';
        }

        // PFC ãƒãƒ£ãƒ¼ãƒˆ
        const ctx = document.getElementById('pfcChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        // ç›®æ¨™ã«å¯¾ã™ã‚‹é”æˆç‡ (%)
        const pRate = (p / userTargets.p) * 100;
        const fRate = (f / userTargets.f) * 100;
        const cRate = (c / userTargets.c) * 100;

        // ã‚¹ã‚³ã‚¢è¨ˆç®— (é©å½“ãªãƒ­ã‚¸ãƒƒã‚¯: 100%ã«è¿‘ã„ã»ã©è‰¯ã„)
        // åå·®ã®çµ¶å¯¾å€¤ã®å¹³å‡ã‚’å¼•ãã‚¤ãƒ¡ãƒ¼ã‚¸
        const diffP = Math.abs(100 - pRate);
        const diffF = Math.abs(100 - fRate);
        const diffC = Math.abs(100 - cRate);
        const avgDiff = (diffP + diffF + diffC) / 3;
        let score = Math.max(0, 100 - avgDiff);
        if (cal === 0) score = 0; // ã¾ã é£Ÿã¹ã¦ãªã„

        document.getElementById('scoreDisplay').textContent = `${Math.floor(score)}ç‚¹`;

        chartInstance = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: ['Protein', 'Fat', 'Carbs'],
            datasets: [{
              label: 'é”æˆç‡ (%)',
              data: [pRate, fRate, cRate],
              backgroundColor: 'rgba(175, 252, 65, 0.2)',
              borderColor: '#affc41',
              pointBackgroundColor: '#affc41',
              borderWidth: 2
            }]
          },
          options: {
            scales: {
              r: {
                angleLines: { color: '#333' },
                grid: { color: '#333' },
                pointLabels: { color: '#fff', font: { size: 12 } },
                suggestedMin: 0,
                suggestedMax: 100,
                ticks: { display: false }
              }
            },
            plugins: {
              legend: { display: false }
            },
            maintainAspectRatio: false
          }
        });

        // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
        const advices = [];
        if (pRate < 80) advices.push("ã‚¿ãƒ³ãƒ‘ã‚¯è³ªãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚é¶è‚‰ã‚„åµã‚’é£Ÿã¹ã¾ã—ã‚‡ã†ï¼");
        if (pRate > 150) advices.push("ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚’æ‘‚ã‚Šã™ãã¦ã„ã¾ã™ã€‚è…è‡“ã«æ°—ã‚’ã¤ã‘ã¦ã€‚");
        if (fRate > 120) advices.push("è„‚è³ªãŒé«˜ã‚ã§ã™ã€‚æšã’ç‰©ã¯æ§ãˆã¾ã—ã‚‡ã†ã€‚");
        if (cRate < 50) advices.push("ã‚¨ãƒãƒ«ã‚®ãƒ¼ä¸è¶³ã‹ã‚‚ã€‚ç‚­æ°´åŒ–ç‰©ã‚‚ã—ã£ã‹ã‚Šæ‘‚ã‚Šã¾ã—ã‚‡ã†ã€‚");
        if (cal > userTargets.cal * 1.1) advices.push("ã‚«ãƒ­ãƒªãƒ¼ã‚ªãƒ¼ãƒãƒ¼ï¼æ˜æ—¥ã¯å°‘ã—é‹å‹•é‡ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚");
        if (advices.length === 0 && cal > 0) advices.push("ç´ æ™´ã‚‰ã—ã„ãƒãƒ©ãƒ³ã‚¹ã§ã™ï¼ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†ï¼");
        if (cal === 0) advices.push("ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä½•ã‹é£Ÿã¹ã¾ã—ãŸã‹ï¼Ÿ");

        document.getElementById('adviceDisplay').textContent = advices.join("\n");
      }

      async function getDailyAIAdvice() {
        if (!currentDayMeals || currentDayMeals.length === 0) {
          return alert("ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã‚‚ã‚‰ã†ã«ã¯ã€ã¾ãšé£Ÿäº‹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚");
        }

        const btn = document.querySelector('button[onclick="getDailyAIAdvice()"]');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 14px; margin-right: 4px;">sync</span>ç”Ÿæˆä¸­...';

        try {
          const res = await fetch(`${apiBase}/api/daily_advice`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              meals: currentDayMeals,
              targets: userTargets
            })
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || "ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const display = document.getElementById('adviceDisplay');
          display.textContent = data.advice;
          display.style.borderLeft = "4px solid var(--accent)";
          display.style.animation = "fadeIn 0.5s ease-out";

        } catch (e) {
          alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      }

      async function deleteMeal(id) {
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const res = await fetch(`${apiBase}/meals/${id}`, { method: 'DELETE' });
        if (res.ok) loadMeals();
      }

      // --- ä½“é‡ç®¡ç†æ©Ÿèƒ½ ---
      let weightChartInstance = null;

      async function addWeight() {
        const date = document.getElementById('weightDate').value;
        const weight = document.getElementById('weightInput').value;

        if (!date || !weight) return alert("æ—¥ä»˜ã¨ä½“é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        const res = await fetch(`${apiBase}/weights`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: currentUser, date, weight: parseFloat(weight) })
        });

        if (res.ok) {
          alert('ä½“é‡ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼');
          document.getElementById('weightInput').value = '';
          loadWeightHistory();
        } else {
          alert('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }

      async function loadWeightHistory() {
        const res = await fetch(`${apiBase}/weights?user_id=${encodeURIComponent(currentUser)}`);
        const data = await res.json();
        renderWeightChart(data);

        const summary = document.getElementById('weightSummary');
        if (data.length >= 2) {
          const latest = data[data.length - 1];
          const prev = data[data.length - 2];
          const diff = (latest.weight - prev.weight).toFixed(1);
          const diffText = diff > 0 ? `+${diff}` : diff;
          summary.textContent = `æœ€æ–°: ${latest.weight}kg (å‰å›æ¯” ${diffText}kg)`;
        } else if (data.length === 1) {
          summary.textContent = `æœ€æ–°: ${data[0].weight}kg (æœ€åˆã®è¨˜éŒ²)`;
        } else {
          summary.textContent = "ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
        }
      }

      function renderWeightChart(data) {
        const ctx = document.getElementById('weightChart').getContext('2d');
        if (weightChartInstance) weightChartInstance.destroy();

        weightChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [{
              label: 'ä½“é‡ (kg)',
              data: data.map(d => d.weight),
              borderColor: '#affc41',
              backgroundColor: 'rgba(175, 252, 65, 0.1)',
              borderWidth: 3,
              tension: 0.3,
              fill: true,
              pointBackgroundColor: '#affc41',
              pointRadius: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                grid: { color: '#334155' },
                ticks: { color: '#94a3b8' },
                suggestedMin: Math.min(...data.map(d => d.weight)) - 2,
                suggestedMax: Math.max(...data.map(d => d.weight)) + 2
              },
              x: {
                grid: { display: false },
                ticks: { color: '#94a3b8' }
              }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      }

      // æ—¥ä»˜å¤‰æ›´æ™‚ã«ãƒªã‚¹ãƒˆæ›´æ–°
      document.getElementById('mealDate')?.addEventListener('change', loadMeals);

    </script>
    <script src="/static/pwa-init.js"></script>
    <style>
      @keyframes slideUp {
        from {
          transform: translateX(-50%) translateY(100px);
          opacity: 0;
        }

        to {
          transform: translateX(-50%) translateY(0);
          opacity: 1;
        }
      }
    </style>
</body>

</html>